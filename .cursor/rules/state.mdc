---
description: State management rules for database and workspace filesystem
globs: ["src/lucy/db/**/*.py", "src/lucy/workspace/**/*.py"]
alwaysApply: false
---

# State Management Rules

## Database (PostgreSQL)
- PostgreSQL via SQLAlchemy async is the single source of truth for relational state (workspaces, users, connections).
- Every query MUST be scoped by `workspace_id` — no exceptions.
- Use Alembic for all schema changes. Never modify the database outside of migrations.
- Models live in `src/lucy/db/models.py`. Session factory in `src/lucy/db/session.py`.

## Workspace Filesystem (Knowledge Layer)
- All knowledge, skills, learnings, and activity logs live as plain files on the local filesystem.
- No vector databases, no embeddings, no RAG. Use `grep` / file search for retrieval.
- Workspace root: `{LUCY_WORKSPACE_ROOT}/{workspace_id}/`
- Standard layout inside each workspace:
  - `skills/` — SKILL.md files with YAML frontmatter
  - `crons/` — task.json definitions and LEARNINGS.md per cron
  - `company/SKILL.md` — company profile and context
  - `team/SKILL.md` — team member profiles
  - `logs/` — daily activity logs (YYYY-MM-DD.md)
  - `state.json` — workspace runtime state

## Multi-Tenant Isolation
- Workspace data is NEVER mixed. Every DB table has `workspace_id`.
- Each workspace has its own filesystem directory.
- Credentials are scoped per-workspace via Composio entity IDs.

## File Writes
- All workspace file operations go through `src/lucy/workspace/filesystem.py`.
- Never write workspace files directly — always use the `WorkspaceFS` interface.
- File writes are atomic (write to temp, then rename).
